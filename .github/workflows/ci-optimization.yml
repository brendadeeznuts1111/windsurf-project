name: CI/CD Optimization - Bun 1.3 Test Runner
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_ENV: test
  BUN_VERSION: "1.3.2"

jobs:
  # ===== PARALLEL TEST EXECUTION =====
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run unit tests with concurrency
        run: |
          bun test packages/*/src/__tests__/unit/ \
            --max-concurrency 15 \
            --randomize \
            --seed ${{ github.run_number }} \
            --timeout 60000
      
      - name: Upload unit test coverage
        uses: codecov/codecov-action@v3
        with:
          flags: unit-tests
          name: unit-test-coverage

  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Start test services
        run: |
          # Start databases, services needed for integration tests
          docker-compose -f docker-compose.test.yml up -d
          sleep 10
      
      - name: Run integration tests
        run: |
          bun test packages/*/src/__tests__/integration/ \
            --max-concurrency 8 \
            --randomize \
            --seed ${{ github.run_number }} \
            --timeout 120000
      
      - name: Cleanup test services
        if: always()
        run: docker-compose -f docker-compose.test.yml down
      
      - name: Upload integration test coverage
        uses: codecov/codecov-action@v3
        with:
          flags: integration-tests
          name: integration-test-coverage

  property-tests:
    name: Property Tests (High Concurrency)
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run property tests with maximum concurrency
        run: |
          bun test property-tests/ \
            --max-concurrency 20 \
            --randomize \
            --seed ${{ github.run_number }} \
            --timeout 180000 \
            2>&1 | tee property-test-output.log
      
      - name: Extract seed for reproduction
        if: failure()
        run: |
          SEED=$(grep "seed:" property-test-output.log | head -1 | cut -d' ' -f2)
          echo "SEED=$SEED" >> $GITHUB_ENV
          echo "üé≤ Property tests failed with seed: $SEED"
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: property-test-logs
          path: property-test-output.log
          retention-days: 30
      
      - name: Upload property test coverage
        uses: codecov/codecov-action@v3
        with:
          flags: property-tests
          name: property-test-coverage

  type-tests:
    name: Type Tests & Compilation
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run type tests
        run: |
          bun test "**/*.types.test.ts" \
            --max-concurrency 10 \
            --timeout 60000
      
      - name: TypeScript compilation check
        run: bunx tsc --noEmit --project tsconfig.json
      
      - name: Upload type test coverage
        uses: codecov/codecov-action@v3
        with:
          flags: type-tests
          name: type-test-coverage

  # ===== PERFORMANCE BENCHMARKS =====
  performance-tests:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run performance benchmarks
        run: |
          bun test packages/*/src/__tests__/performance/ \
            --max-concurrency 5 \
            --timeout 300000
      
      - name: Generate performance report
        run: bun scripts/benchmark/generate-report.ts
      
      - name: Upload performance report
        uses: actions/upload-artifact@v3
        with:
          name: performance-report
          path: performance-report.json
          retention-days: 90

  # ===== QUALITY GATES =====
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 6
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Golden Rules validation
        run: bun scripts/validation/validate-golden-rules.ts
      
      - name: Check for test.only in CI
        run: |
          if grep -r "test\.only" packages/ property-tests/; then
            echo "‚ùå test.only found in codebase - remove before merging"
            exit 1
          else
            echo "‚úÖ No test.only found"
          fi
      
      - name: Lint code
        run: bunx eslint packages/ --ext .ts,.tsx
      
      - name: Format check
        run: bunx prettier --check packages/ property-tests/

  # ===== SECURITY SCANS =====
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Security audit
        run: bun audit
      
      - name: SAST scan
        run: bunx semgrep --config=auto packages/

  # ===== DEPLOYMENT READINESS =====
  deploy-ready:
    name: Deployment Readiness Check
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, property-tests, type-tests, code-quality]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: All tests passed
        run: |
          echo "‚úÖ All test suites passed"
          echo "‚úÖ Code quality checks passed"
          echo "‚úÖ Ready for deployment"
      
      - name: Generate deployment artifact
        run: |
          tar -czf deployment-artifact.tar.gz \
            packages/ \
            property-tests/ \
            scripts/ \
            bun.lock \
            bunfig.toml \
            tsconfig.json
      
      - name: Upload deployment artifact
        uses: actions/upload-artifact@v3
        with:
          name: deployment-artifact
          path: deployment-artifact.tar.gz
          retention-days: 7

  # ===== FLAKY TEST DETECTION =====
  flaky-test-detection:
    name: Flaky Test Detection
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: ${{ env.BUN_VERSION }}
      
      - name: Install dependencies
        run: bun install --frozen-lockfile
      
      - name: Run tests multiple times with different seeds
        run: |
          for i in {1..5}; do
            echo "üé≤ Run $i with random seed"
            SEED=$((RANDOM + i))
            bun test --randomize --seed=$SEED --timeout 120000 || {
              echo "‚ùå Flaky test detected with seed: $SEED"
              echo "üîç To reproduce: bun test --seed=$SEED"
              exit 1
            }
          done
          echo "‚úÖ No flaky tests detected in 5 runs"
